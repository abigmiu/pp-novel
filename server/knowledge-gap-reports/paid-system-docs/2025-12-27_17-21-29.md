# 付费体系需求与技术设计（自动充值版）

> 范围：先实现站内钱包/余额与章节购买，无需真实支付渠道。提交充值请求即自动入账，后续可无缝替换真实支付网关。

## 1. 目标与范围
- 面向角色：读者、作者（收益统计）、运营（对账、人工调账）。
- 目标：支持充值、余额消费、章节解锁、打赏，保障资金数据可追溯、可对账、可扩展到真实支付。
- 非目标：暂不对接三方支付；暂不实现提现（仅预留）。

## 2. 关键概念
- 钱包（Wallet）：每个用户唯一，记录可用余额与累计充值/消费。
- 充值单（RechargeOrder）：模拟支付的订单，提交即自动成功，生成账单流水。
- 消费单（ConsumeOrder）：章节解锁、打赏、订阅等消费记录。
- 账单流水（WalletTxn）：不可变流水，记录每一次加/扣与关联订单，支持对账与撤销。
- 锁定/幂等：同一请求号只能成功一次，避免重复扣/充。

## 3. 业务流程
- 充值（自动成功）  
  1) 前端提交金额、支付渠道=mock、clientRequestId。  
  2) 后端创建 RechargeOrder（PENDING）→ 校验幂等 → 自动标记 SUCCESS → 写 WalletTxn（充值）→ 增加余额。  
  3) 返回充值成功与最新余额。
- 章节购买  
  1) 校验用户登录、章节状态可售、价格。  
  2) 原子扣减余额、写 ConsumeOrder（SUCCESS）、写 WalletTxn（消费）、生成章节授权记录。  
  3) 幂等：同一章节重复购买直接返回已授权。
- 打赏/月票（可选首期）  
  - 同章节购买逻辑，消费类型为 REWARD/VOTE，入账作者收益延后实现。
- 人工调账（运营接口，需权限）  
  - 正/负向调节，必须记录理由与操作人，写 WalletTxn。

## 4. 功能需求明细
- 充值入口：支持固定档位与自定义金额（后端校验最小/最大值），自动成功。
- 余额展示：返回可用余额、最近交易（分页）、累计充值/消费。
- 章节价格策略：允许免费、限时免费、付费（价格存章节表或价格表），可预留会员折扣。
- 授权有效性：购买后永久解锁该章节；后续可扩展租赁型。
- 并发与一致性：余额变更与流水写入必须在同一事务，防止部分成功。
- 幂等：充值使用 clientRequestId，消费使用 (userId, chapterId, bizType) 去重。
- 风控/限流：限制单日最大充值次数与金额（配置），限制重复快速点击。
- 运营对账：可按日汇总充值/消费金额、笔数。
- 可扩展：预留提现、分账、优惠券、限免活动的字段/状态。

## 5. 非功能
- 金额精度：全部使用 `BigDecimal`，统一单位「元」；存库 DECIMAL(18,2)。运算避免二进制浮点。
- 日志与审计：关键流程记录 userId、orderId、requestId、金额、IP/UA。
- 性能：充值/消费单笔低延迟；列表分页查询加索引；后续可缓存余额（谨慎缓存写）。
- 安全：鉴权使用现有 Sa-Token；运营接口需角色/权限校验。

## 6. 数据模型（建议表）
- `wallet`：`id`, `user_id`(UK), `balance`, `total_recharge`, `total_consume`, `created_at`, `updated_at`.
- `wallet_txn`：`id`, `user_id`, `type`(RECHARGE/CONSUME/ADJUST/REFUND), `biz_id`(订单ID), `biz_type`(RECHARGE_ORDER/CONSUME_ORDER/ADJUST), `amount`, `direction`(IN/OUT), `balance_after`, `request_id`, `remark`, `created_at`.（仅追加，不可更新）
- `recharge_order`：`id`, `order_no`, `user_id`, `amount`, `status`(PENDING/SUCCESS/FAILED), `channel`(MOCK), `request_id`, `created_at`, `updated_at`.
- `consume_order`：`id`, `order_no`, `user_id`, `amount`, `status`, `biz_scene`(CHAPTER/REWARD/VOTE), `target_id`(chapterId 等), `request_id`, `created_at`, `updated_at`.
- `chapter_access`：`id`, `user_id`, `chapter_id`, `granted_at`, `grant_type`(PURCHASE/FREE/ACTIVITY)，保证唯一(user_id, chapter_id)。
- 索引：`wallet.user_id` 唯一；`wallet_txn.user_id, created_at`；`recharge_order.request_id` 唯一；`consume_order.user_id, target_id, biz_scene` 唯一约束防重复。

## 7. 接口草案（后端）
- `POST /api/pay/recharge`：body{amount, requestId} → 自动成功，返回 orderNo, balance.
- `GET /api/pay/balance`：返回余额、累计、最近交易分页。
- `POST /api/pay/chapters/{chapterId}/buy`：body{requestId?} → 成功后返回授权。
- `POST /api/pay/reward`（可选首期）：body{targetId, amount, requestId}。
- `GET /api/pay/txns`：分页查询 WalletTxn（类型筛选）。
- 运营：`POST /api/pay/admin/adjust`（需要权限），body{userId, amount, reason, requestId}。

## 8. 边界与异常场景
- 重复充值：同 requestId 再次调用直接返回首次结果。
- 余额不足：消费返回业务码 402/提示充值。
- 章节状态异常：下架/未发布不可购买；若已购买则直接返回授权。
- 并发扣款：同一用户多个消费并发需串行化（数据库行锁或分布式锁）以防超扣。
- 金额非法：<=0 或超过上限拒绝。

## 9. 验收要点
- 正常充值后余额准确，流水有记录。
- 同一充值请求重复提交不重复入账。
- 余额不足购买返回错误，充值后可成功购买。
- 已购章节重复购买不重复扣款。
- 列表接口可分页，运营调账正确计入流水与余额。

## 10. 技术设计
- 框架：沿用 Spring Boot + MyBatis-Plus；新实体与 Mapper 按现有风格放在 `common` 模块；服务/Controller 放 `web`。
- 金额类型：统一 `BigDecimal`，数据库 DECIMAL(18,2)，金额比较用 `compareTo`。
- 事务：充值、消费、调账均使用 `@Transactional`，顺序：写订单/流水 → 更新余额 → 生成授权/返回；抛异常则回滚。
- 并发控制：  
  - DB 行锁：`SELECT ... FOR UPDATE`/MyBatis-Plus 更新条件包含版本或余额检查。  
  - 幂等键：`request_id` 唯一，若存在则直接返回。  
  - 可选分布式锁（Redis SET NX）包装消费操作。
- 流水保证：`wallet_txn` 仅插入，不更新，不删除；包含余额后值用于审计。
- 授权写入：购买成功后插入 `chapter_access`，唯一约束防重复。
- 价格获取：章节表新增价格字段或独立价格表，读取时校验。
- 日志与审计：关键节点 INFO + 失败 WARN/ERROR，日志里携带 userId/orderNo/requestId。
- 配置：充值开关、最大金额、免费/限免策略走 `application-*.yml` 配置或后续配置中心。
- 预留真实支付：`channel` 字段可扩展 ALIPAY/WX；状态机保持通用（PENDING→SUCCESS/FAILED），目前直接成功。

## 11. 中间件与扩展建议
- Redis：用于幂等锁与防重（requestId），以及限流计数；暂不缓存余额（避免双写不一致）。
- MQ（后续）：充值/消费成功事件投递统计/通知/推荐模块；当前可直接同步返回。
- 任务调度：每日生成对账汇总，清理过期限免；可用 `@Scheduled` 首期实现。
- 监控：引入 Actuator 观察交易接口耗时，后续接入指标与告警。

## 12. 迭代拆分建议
- M1：表结构 + 钱包创建 + 模拟充值接口 + 余额查询 + 交易流水。
- M2：章节购买流程 + 授权表 + 幂等/并发控制 + 运营调账。
- M3：对账汇总 + 限流/风控（充值金额/次数）+ 监控与告警。
- M4：接入真实支付（可选），收益分账、提现、优惠券/限免活动。

