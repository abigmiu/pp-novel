# 通知中心 - 需求文档

## 背景与目标
- 将站内信、邮件、短信、WebSocket 推送统一管理，避免前端多处接不同接口。
- 支持状态回执（送达/失败/已读）、模板化，便于运营与多语言扩展。

## 范围
- 通道：站内信、邮件、短信、WebSocket（实时提醒）。
- 场景：关注作者更新、评论回复、系统公告、审核结果、活动通知。
- 功能：通知发送、列表查询、未读计数、标记已读、重发/补偿。

## 用户场景
- 读者关注的作者更新章节时，收到实时 WebSocket 提醒和站内信；离线用户通过邮件兜底。
- 评论被回复时，收到站内信和移动端推送（如需）；点击后自动标记已读。
- 系统公告/运营活动推送给指定人群，前端展示弹窗或消息入口。

## 交互与体验要求
- 列表分页展示，显示类型、标题、摘要、创建时间、已读状态、关键动作（如「查看章节」）。
- 消息入口显示未读数徽标；点击详情或「全部标记已读」后同步更新徽标。
- WebSocket 断线自动重连；失败后前端可轮询未读数。
- 消息弹窗需可配置：只显示一次/每天一次；可关闭并记录关闭状态。

## API 需求（给前端）
- `GET /api/notify/unread-count`：返回 `{count}`。
- `GET /api/notify/list?page=1&size=20&type=all|system|reply|update|activity`：返回 `items[]`（`id,title,contentSnippet,type,status,createdAt,actionUrl`）、`total`。
- `POST /api/notify/read`：请求 `{ids:[]}` 批量标记已读。
- `POST /api/notify/read-all`：全量标记已读。
- WebSocket/SSE：`/api/notify/stream` 推送 `{id,title,type,actionUrl,createdAt}`。
- 推送测试/订阅：`POST /api/notify/subscribe`，前端可上传设备/浏览器标识用于多端同步。
- 错误码：`401` 未登录、`429` 频控、`503` 通知服务不可用。

## 埋点
- 消息曝光、点击、标记已读、关闭弹窗。
- 送达失败原因分布（对前端暴露为简短提示即可）。

## 验收标准
- 未读数与列表一致性（误差 0），消息状态实时可见。
- WebSocket 可在 3s 内收到新消息；断线后 10s 内恢复或自动切换轮询。
- 批量已读接口在 500ms 内响应。

## 非功能
- 频控：同一用户消息拉取接口每分钟 ≤ 30 次；WebSocket 心跳 30s。
- 容错：推送失败自动记录并可重试，前端可主动补偿拉取。
- 可观测：各通道送达率、失败率、延迟、客户端连接数。
