# 活动与运营 - 设计文档

## 架构概览
- **入口**：ActivityController 提供活动列表、详情、参与接口。
- **规则引擎**：ActivityService 调用规则校验器（时间/人群/次数/库存），执行对应动作（发券、扣积分、授予权益）。
- **数据存储**：MySQL 活动表、券表、奖池表；Redis 用于库存扣减、次数限制、弹窗状态。
- **异步任务**：活动上下线、券过期回收、奖池结算使用定时任务或消息队列触发。

## 数据模型
- `activity`：id, type (FREE/COUPON/LOTTERY/POPUP), status, start_at, end_at, rules(json), config(json), created_at, updated_at。
- `coupon`：id, activity_id, face_value, threshold, discount_rate, valid_start, valid_end, stock, channel。
- `user_coupon`：id, user_id, coupon_id, status (AVAILABLE/USED/EXPIRED), order_id。
- `lottery_prize`：id, activity_id, name, type (ENTITY/POINT/COUPON/NONE), rate, stock。
- `activity_log`：记录参与/领取/抽奖结果。

## 核心流程
- **限时免费**：校验活动时间与书/章节匹配；Redis 缓存活动配置。阅读前调用 `/free/check`，通过后下游付费校验放行。
- **兑换券**：
  - 领取：校验资格、库存，Redis `DECR` 库存，成功后写 `user_coupon`。
  - 兑换码：校验码有效期、次数，幂等后发券。
  - 使用：订单结算时校验状态/门槛，扣减一次并记录。
- **抽奖**：
  - 资格校验：频控 + 积分/抽奖券扣减（Redis Lua 保证原子）。
  - 抽取：根据奖品概率做加权随机，扣减奖池库存（Redis）。
  - 结果：记录日志，若奖品为券/积分即时发放；实体奖品进入发货流程。
- **运营弹窗**：返回配置（展示频次、关闭有效期），关闭事件写 Redis，按用户维度控制。

## 接口细节
- 列表/详情直接读 DB + 缓存，附 `status`、`timeLeft`、`rules`。
- 参与接口返回 `traceId`，异常时附原因码（`NOT_STARTED`、`ENDED`、`NO_STOCK`、`LIMIT_REACHED`）。
- 抽奖响应示例：`{result: win|lose, prize: {name,type,value?}, nextAvailableAt, balanceChanges}`。

## 并发与一致性
- 库存/次数：Redis 脚本原子扣减，扣成功后异步落库；失败回滚扣减。
- 幂等：`userId+activityId` 作为领取幂等键，`lottery_draw:{userId}:{activityId}` 防并发。
- 灰度：活动配置含灰度规则（用户分桶、地域、设备）。

## 安全与风控
- 频控：令牌桶/滑动窗口；对兑换码尝试次数限制。
- 防刷：需要登录；高风险 IP/设备限制参与；敏感活动可要求二次验证。

## 可观测性
- 指标：`activity_join_count`、`coupon_claim_fail_rate`、`lottery_success_rate`、`pool_stock`。
- 日志：全链路 `traceId`；记录失败原因。
- 告警：库存<阈值、奖池为负、异常率提升。

## 前端接入要点
- 展示倒计时基于后端 `serverTime` 和 `start/end`；到期自动刷新状态。
- 提交参与后禁用按钮；超时 5s 恢复。
- 领取/抽奖接口返回的 `nextAvailableAt` 用于提示冷却时间。
- 弹窗关闭后调用 `/popup/close`，后端记录避免重复展示。
