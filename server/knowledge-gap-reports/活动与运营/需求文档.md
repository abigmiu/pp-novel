# 活动与运营 - 需求文档

## 背景与目标
- 通过限时免费、兑换券、抽奖等活动提升拉新与留存。
- 为前端提供统一的活动入口、规则展示、状态反馈，减少对后端逻辑的猜测。

## 范围
- 活动类型：限时免费/折扣、兑换券（满减/直减/折扣）、抽奖/盲盒、运营弹窗。
- 功能：活动列表展示、详情页、领取/参与、校验、消耗、结果展示。
- 权限：登录可参与；部分活动需绑定手机/邮箱；需防刷/防重复。

## 用户场景
- 限时免费：用户在活动期间可免费阅读指定章节；活动结束自动恢复付费。
- 兑换券：用户领取或输入兑换码，订单结算时抵扣；前端需要展示可用券、不可用原因。
- 抽奖：用户消耗积分/抽奖券参与，立即返回中奖结果，展示奖品/未中奖提示。
- 运营弹窗：首次进入首页弹窗提示活动，关闭后一天内不再显示。

## 交互与体验要求
- 活动列表展示标题、时间、状态（未开始/进行中/已结束）、入口按钮。
- 详情页展示规则、剩余时间倒计时、参与条件、奖品列表。
- 参与操作需即时反馈（loading、成功/失败提示），失败需展示具体原因。
- 抽奖动画：客户端可做 2~3s 动画，后端返回结果需支持预先渲染。
- 防重复提交：按钮点击后禁用，等待接口返回或超时（5s）恢复。

## API 需求（给前端）
- `GET /api/activity/list?type=all|free|coupon|lottery`：活动列表。
- `GET /api/activity/{id}`：活动详情，含规则、时间、状态、奖品/券信息。
- 领取/参与：
  - 限时免费无需额外领取，只校验资格：`POST /api/activity/free/check` `{bookId, chapterId}`。
  - 兑换券领取：`POST /api/activity/coupon/claim` `{couponId}`；兑换码：`POST /api/activity/coupon/redeem` `{code}`。
  - 抽奖：`POST /api/activity/lottery/draw` `{activityId}`，响应 `{result, prize?, nextAvailableAt, balanceChanges}`。
- 运营弹窗状态：`POST /api/activity/popup/close` `{popupId}` 记录关闭。
- 错误码：`401` 未登录、`403` 不满足条件、`409` 重复领取、`429` 频控、`410` 活动已过期、`503` 活动服务不可用。

## 埋点
- 活动曝光、点击、参与、领取成功/失败、抽奖结果分布、弹窗关闭。
- 关键字段：`activityId`、`type`、`result`、`reason`。

## 验收标准
- 活动状态切换及时（未开始->进行中->结束），前端刷新即可生效。
- 兑换券可在订单页正确展示与使用，不可用时给出原因。
- 抽奖接口 P95 < 1s，结果准确且防重入。
- 防刷有效：频控命中时返回 429，文案清晰。

## 非功能
- 频控：抽奖/领取接口单用户每分钟 ≤ 10 次；兑换码校验防暴力尝试。
- 容错：活动配置异常时前端展示「活动暂不可用」并给出 traceId。
- 可观测：参与人数、成功率、库存消耗、异常率监控；抽奖奖池余额告警。
