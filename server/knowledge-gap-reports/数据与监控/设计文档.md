# 数据与监控 - 设计文档

## 架构概览
- **指标**：引入 Spring Boot Actuator + Micrometer 暴露 `/actuator/prometheus`；部署 Prometheus 拉取，Grafana 展示。
- **链路追踪**：使用 Sleuth/Zipkin（或 OpenTelemetry），为每个请求生成 `traceId`，写入响应头与日志。
- **日志**：统一 JSON 日志格式，字段含 `timestamp, level, traceId, spanId, service, uri, method, status, costMs, userId(masked), message`；按天滚动。
- **告警**：Prometheus Alertmanager 配置延迟/错误率/资源指标告警。

## 采集指标
- 系统指标：CPU、内存、GC、线程、连接池、队列长度。
- 接口指标：QPS、延迟（P50/P90/P95/P99）、错误率、超时率。
- 业务指标：登录成功率、下单/支付成功率、搜索命中率、审核通过率。
- 消息/任务：队列堆积、消费延迟、定时任务耗时。

## 技术方案
- 在 `web/pom.xml` 引入 Actuator + Micrometer Prometheus 依赖；配置 `management.endpoints.web.exposure.include=health,metrics,prometheus,info`。
- Trace 生成：过滤器在请求入口创建/获取 `traceId`，放入 MDC；响应头写 `X-Trace-Id`，响应体透出 `traceId` 字段。
- 日志：Logback JSON encoder，使用 MDC 输出 traceId、userId（脱敏）。慢请求阈值（如 800ms）单独打 WARN。
- 采样率：调用链采样默认 10%~20%，可按路径配置。

## 仪表盘与告警示例
- 仪表盘：接口耗时/错误率、Top 慢接口、数据库慢查询、缓存命中率、消息堆积、业务漏斗（注册->下单->支付）。
- 告警规则示例：`http_request_duration_seconds_bucket{uri="/api/search"} P95 > 0.8s for 5m`；`http_server_requests_errors_total` 激增；`rabbitmq_queue_messages_ready` 堆积。

## 数据流
- 应用 -> Micrometer 收集 -> `/actuator/prometheus` -> Prometheus 拉取 -> Grafana 展示/告警。
- 应用 -> Sleuth/Zipkin -> Zipkin Server 保存调用链。
- 应用 -> Logback -> 本地文件/日志收集器（如 Filebeat） -> 日志平台。

## 安全与隔离
- Actuator 端点需鉴权或仅对内网开放；健康检查可匿名。
- 日志脱敏：手机号/邮箱/身份证做部分掩码；禁止输出明文密码/token。
- 监控故障时降级：指标写入失败不阻塞业务，日志写入异常回落文本格式。

## 前端接入要点
- 读取响应头 `X-Trace-Id` 或响应体 `traceId`，在错误提示中展示；上报前端错误时附带。
- 可在诊断页面调用 `/actuator/health` 显示服务状态。
- 前端性能埋点可复用 `/api/track`，与后端指标统一关联 traceId。
