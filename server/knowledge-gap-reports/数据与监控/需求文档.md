# 数据与监控 - 需求文档

## 背景与目标
- 当前缺少运行指标、链路追踪、日志标准化，问题排查成本高。
- 需要为前端提供稳定的接口质量监控与可回溯的 traceId，方便联调。

## 范围
- 应用健康：接口 QPS/延迟/错误率、线程池/队列监控、JVM 指标。
- 业务指标：注册/登录成功率、下单/支付成功率、搜索命中率、审核通过率。
- 日志与追踪：统一日志格式、traceId 贯穿、慢请求/错误记录。
- 报警与自助看板：Prometheus/Grafana 或类似方案；报警规则。

## 用户场景
- 前端在接口错误时能拿到 `traceId`，运维可用该 ID 查日志和调用链。
- 运营关注活动/支付转化的实时指标；研发关注接口耗时和失败原因。
- 发生性能问题时，可快速定位瓶颈（数据库、缓存、外部依赖）。

## 体验与交互要求
- 接口响应头返回 `X-Trace-Id`，响应体含 `traceId` 字段。
- 慢接口/错误接口需在日志中记录请求参数关键字段、用户 ID（脱敏）、耗时。
- 前端错误页提示「请提供 traceId 以便排查」。

## API/输出需求（给前端）
- 无需额外业务接口，但需保证所有业务接口在响应中携带 `traceId`。
- 预留健康检查：`GET /actuator/health`（前端可用于探活或诊断页）。
- 日志/监控数据由后端接入，不暴露直接接口给前端。

## 埋点
- 页面性能（FMP、TTI）、接口耗时、错误码分布；前端可上报到后端 `/api/track` 统一存储。
- 关键业务事件成功/失败数量。

## 验收标准
- 主要接口（搜索、登录、下单）返回体含 `traceId` 且日志可查。
- Actuator 健康检查可用；Prometheus 指标可抓取。
- 核心接口 P95 延迟、错误率有可视化看板；超过阈值触发报警。

## 非功能
- 性能开销可控：监控埋点开销 < 5%。
- 安全：日志脱敏（手机号/邮箱/ID 部分掩码），traceId 不含业务信息。
- 高可用：监控组件异常不影响主链路（异步上报，降级）。
