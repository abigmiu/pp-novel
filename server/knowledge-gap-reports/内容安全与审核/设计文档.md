# 内容安全与审核 - 设计文档

## 架构概览
- **入口**：ReviewController 暴露文本/图片审核接口。
- **异步流水**：前端提交 -> API 校验 -> 投递到消息队列（review.topic） -> 机器审核服务消费 -> 结果写入数据库/Redis -> 回执推送（WebSocket/SSE）/供前端查询。
- **人工审核**：机器拒绝或高风险命中后，将记录推送到人工审核后台队列。

## 模块设计
- `service/review/TextReviewService`：敏感词本地校验、调用第三方文本审核（可抽象 Provider）。
- `service/review/ImageReviewService`：图片基本校验（大小/格式/MIME）、调用第三方图片审核。
- `service/review/ResultService`：落库、缓存、推送结果，提供查询。
- `component/SensitiveWordFilter`：基于 DFA/Trie 本地敏感词扫描，先行拦截。
- `messaging/ReviewConsumer`：消费审核任务与回执，处理重试/死信。
- **存储**：MySQL 表 `review_task`（id, entity_id, type, status, reason, suggestion, risk_level, created_at, updated_at），Redis 缓存热数据。

## 状态流转
1. 前端提交 -> 状态 `PENDING`。
2. 进入机器审核 -> `MACHINE_CHECKING` -> 结果 `MACHINE_PASS` 或 `MACHINE_REJECT`。
3. `MACHINE_REJECT` 且风险中高 -> 进入人工队列 `MANUAL_PENDING` -> `MANUAL_PASS/REJECT`。
4. 前端查询或推送获取最终状态；人工拒绝允许 `REAPPLY`。

## 接口与返回字段
- `POST /api/review/text` / `image`：返回 `{reviewId, status: pending, nextPollSec: 3, traceId}`。
- `GET /api/review/status`：返回 `{status, reason, suggestion, updatedAt, traceId}`。
- SSE 推送：`event: review_status`, data 包含 `reviewId, status, reason`。
- 错误处理：参数异常直接返回 400；上游审核超时写入 `status=TIMEOUT` 并提示重试/人工。

## 队列与重试
- 主题：`review.topic`；死信：`review.dlq`。
- 延迟重试：图片审核/第三方调用失败重试 3 次（指数退避），仍失败进入人工。
- 幂等：`reviewId` 作为唯一键，消费端幂等更新。

## 安全与合规
- 文件安全：校验 MIME、大小、分辨率；对外 URL 采用临时凭证；禁止 SVG/可执行类型。
- 隐私：脱敏日志，不记录明文敏感内容；审计人工操作。
- 频控：基于用户 ID/IP 令牌桶限流。

## 可观测性
- 指标：`review_latency_ms`、`review_pass_rate`、`review_reject_reason_count`、`review_retry_count`。
- 日志：按 `traceId` 记录调用链；第三方响应码。
- 告警：审核服务不可用、拒绝率陡增、死信堆积。

## 前端接入细节
- 提交后立即展示「审核中」，并开启轮询/订阅；多项提交需逐条跟踪。
- 图片上传先本地压缩（<=1MB）再传；超时显示可重试入口。
- 展示拒绝原因/建议；支持重新提交沿用同 `entityId`。
- 对于评论，前端在输入阶段可请求 `/api/review/text` 的快速校验模式（仅本地敏感词）提升体验。
