# 内容安全与审核 - 需求文档

## 背景与目标
- 小说投稿、评论、封面存在违规风险，需要自动+人工组合的审核链路。
- 保障前端体验：提交后给出明确的状态反馈与进度提示，避免「提交无响应」。

## 范围
- 覆盖对象：章节正文、评论、书籍封面/插图、作者简介。
- 审核类型：机器审核（文本/图片）、人工复核、异步回执、申诉。
- 状态管理：待审、机器通过、机器拒绝、人工通过、人工拒绝、重新提交。

## 用户场景
- 作者发布章节：提交后进入「审核中」，机器审核通过直接上线，失败进入人工审核；人工拒绝后给出原因，作者可修改重新提交。
- 读者评论：实时敏感词拦截，异步机器审核；高风险评论直接屏蔽并提示。
- 图片上传：前端压缩 + 上传后显示「审核中」，通过后自动替换为正式地址，拒绝显示占位与原因。

## 交互与体验要求
- 提交动作应立刻返回请求受理状态（202/200），并给出审核中提示。
- 前端可轮询或通过 WebSocket/SSE 订阅审核结果；轮询间隔 3~5s。
- 审核失败需展示明确的拒绝原因和整改建议；支持「重新提交」。
- 批量提交（如多张图片）应分项展示状态与失败原因。

## API 需求（给前端）
- 文本审核：`POST /api/review/text`，请求 `{type: chapter|comment|intro, content, entityId}`；响应 `{reviewId, status}`。
- 图片审核：`POST /api/review/image`，请求 `{type: cover|illustration, fileUrl, entityId}`；响应 `{reviewId, status}`。
- 状态查询：`GET /api/review/status?reviewId=xxx` 或 `GET /api/review/status/batch?ids=a,b,c`。
- 结果推送：`/api/review/stream`（SSE/WebSocket）推送 `{reviewId, status, reason, suggestion}`。
- 申诉：`POST /api/review/appeal`，请求 `{entityId, type, reason, attachments[]}`。
- 错误码：`400` 参数异常、`413` 内容超长、`429` 频率限制、`503` 审核服务不可用。

## 埋点
- 提交审核请求、审核结果（通过/拒绝/超时）、人工介入次数、平均审核耗时。
- 评论实时拦截的命中率与误判率。

## 验收标准
- 文本审核 P95 耗时 < 1s（机器流程），图片审核 P95 < 2s。
- 提交后 1s 内返回受理结果，拒绝时能看到原因。
- 审核状态可查询/可推送，页面刷新后能恢复状态。
- 频控：单用户提交审核请求每分钟 ≤ 20 次。

## 非功能
- 灰度：按用户、按内容类型开关机器审核；异常时自动切换人工审核。
- 容错：审核超时 5s 自动回落人工；回执异常可重新查询。
- 可观测：审核通过率/拒绝率、耗时、失败原因分布、敏感词 Top 列表。
