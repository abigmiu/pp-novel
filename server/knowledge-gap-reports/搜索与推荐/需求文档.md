# 搜索与推荐 - 需求文档

## 背景与目标
- 让读者快速准确地找到想看的书，减少空搜索和跳出率。
- 通过推荐与热榜提升曝光与留存，支撑后续商业化（付费转化、运营活动）。
- 对前端友好：提供清晰的接口、字段含义、错误码及交互反馈要求。

## 范围
- **搜索**：关键词搜索、作者搜索、自动补全、结果高亮。
- **推荐/榜单**：基于阅读/收藏/热度的推荐流与榜单（小时榜、日榜）。
- **埋点与召回**：前端上报搜索/点击/阅读埋点，支撑召回与排序。
- **灰度与回退**：搜索/推荐双通道（老版 DB 查询、新版 ES/召回），支持切换。

## 用户场景
- 读者输入书名/作者/标签，实时提示候选；回车后展示结果并高亮匹配词。
- 进入首页或书籍详情时，展示个性化推荐及热榜；点击后记录曝光与点击。
- 搜索结果为空时提供「猜你想搜」「热门标签」兜底。

## 交互与体验要求
- 搜索框 200ms 内给出自动补全结果；节流 300ms。
- 结果列表需展示：封面、书名、作者、标签、简介片段、最新章节时间、热度。
- 高亮字段：命中的书名/作者/标签/简介片段，用 `<em>` 包裹。
- 空态：展示「未找到相关作品」，附带热门搜索/猜你想搜。
- 失败态：网络/服务错误提示「搜索暂时不可用，请稍后再试」。

## API 需求（给前端）
- `GET /api/search/suggest?q=词&size=10`：返回建议词数组，含类型（书名/作者/标签）。
- `GET /api/search?q=词&page=1&size=20&sort=score|hot|new`  
  - 响应字段：`items[]`（`id`、`title`、`author`、`tags[]`、`coverUrl`、`introSnippet`、`latestChapter`、`updatedAt`、`hotScore`、`matchHighlights`）、`total`、`tookMs`、`traceId`。
- `GET /api/feed/recommend?page=1&size=20`：推荐流；携带登录 token 时做个性化，未登录走公共流。
- `GET /api/feed/rank?type=hour|day|week&page=1&size=20`：榜单。
- 错误码：`400`（参数非法）、`429`（限流）、`503`（搜索服务不可用）；响应需含 `traceId`。

## 埋点与数据
- 搜索：曝光（输入框 focus）、提交（关键词、时长）、结果曝光（列表位置）、点击（位置、结果 ID）、无结果。
- 推荐/榜单：feed 拉取曝光、卡片曝光、点击、停留时长。
- 埋点接口建议：`POST /api/track`，前端异步/批量上报，失败重试 1 次。

## 验收标准
- 自动补全 P95 耗时 < 300ms，搜索结果 P95 < 800ms。
- 高频关键词（前 50）命中率 ≥ 95%，空结果兜底命中率 ≥ 80%。
- 推荐流无登录可用，登录后结果可感知差异；曝光/点击埋点正常入库。
- 接口返回 `traceId`，日志可根据 trace 查询。

## 非功能
- 限流：搜索、推荐接口单 IP 每分钟 60 次；过载返回 429。
- 容错：搜索超时回退到 MySQL 模糊查询；推荐超时回退热门榜单。
- 可观测：接口耗时、命中率、空结果率、错误码分布暴露到监控。
