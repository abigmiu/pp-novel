# 搜索与推荐 - 设计文档

## 总体架构
- **检索链路**：前端 -> API（SearchController）-> SearchService -> ES 集群（书索引）-> 结果高亮 -> 缓存（热门词/榜单）-> 响应。
- **推荐链路**：前端 -> FeedController -> FeedService -> 召回（Redis Sorted Set 热榜 + 规则召回）-> 排序 -> 返回。
- **埋点链路**：前端 -> TrackController -> Kafka（或 RabbitMQ）-> Flink/消费服务 -> 更新热榜、画像、ES 辅助字段。

## 模块与组件
- `web/src/main/java/.../controller/SearchController`：提供 `/search`、`/search/suggest`、`/feed/*`。
- `service/search`：封装 ES 查询、自动补全、同义词/拼写纠错、降级逻辑。
- `service/feed`：召回策略、Redis 热榜、个性化特征拼装。
- `service/track`：校验埋点数据，异步投递到消息队列。
- **数据存储**：ES（书索引）、MySQL（书基础信息）、Redis（热榜、热门词缓存）。

## 索引与数据模型
- 索引名：`novel_book_v1`
- 字段示例：`id` keyword、`title` text(ik_max_word, with pinyin tokenizer)、`author` text、`tags` keyword、`intro` text、`status` keyword、`category` keyword、`wordCount` long、`updatedAt` date、`hotScore` double。
- 自动补全：`title_suggest` (completion type)。
- 高亮：对 `title`、`author`、`intro` 开启。
- 同义词/拼写：配置同义词文件（如「修仙=仙侠」），开启拼写纠错用于兜底。

## API 设计（请求/响应）
- `GET /api/search/suggest`：返回 `[{text, type}]`，从 ES completion 查询 + 热门词 Redis 缓存。
- `GET /api/search`：参数 `q`、`page`、`size`、`sort`；支持排序 `score|hot|new`。超时 600ms，超时回退 MySQL `LIKE` + Redis 热门榜。
- `GET /api/feed/recommend`：未登录读取 Redis 公共热榜；已登录按用户画像标签（分类、最近阅读）做规则召回。
- `GET /api/feed/rank`：从 Redis Sorted Set 读取，不命中则按数据库聚合重建并回填缓存。
- 埋点 `POST /api/track`：校验 `traceId`、`event`、`payload`，异步投递队列。

## 召回与排序策略
- **召回源**：1) 用户近期阅读的同分类书；2) 全站热榜；3) 新书上架；4) 相似作者。
- **排序**：线性加权 `score = ctr_weight*ctr + hot_weight*hot + freshness_weight*freshness`，权重可配置。
- **多版本灰度**：Header `X-Search-Version` 控制，默认新链路；异常时回退旧链路。

## 缓存与限流
- 热门搜索词、榜单：Redis 缓存 5 分钟，命中率不足时异步预热。
- 限流：Spring Cloud Gateway/Servlet Filter 使用令牌桶，IP 级限流 60 RPM，异常返回 429。
- 防重放：`traceId` + 幂等 token 校验埋点重复提交。

## 失败与降级
- ES 不可用：日志告警 -> 自动切换 MySQL 模糊查询 + 热榜兜底，响应 `traceId`。
- 推荐召回失败：降级返回 Redis 热榜；排序失败直接返回召回列表。
- 自动补全超时：空数组 + 热门词。

## 可观测性
- 指标：`search_took_ms`、`search_hit_rate`、`search_empty_rate`、`feed_latency_ms`、`feed_hit_rate`。
- 日志：记录 `traceId`、`query`、`tookMs`、`resultCount`、`fallback`。
- 慢查阈值：搜索 > 800ms、建议 > 300ms 打印 warning。

## 数据同步与索引更新
- 数据源：MySQL `book` 表。
- 变更监听：小说发布/更新事件写入消息队列，由 Indexer Service 消费更新 ES。
- 全量重建：后台触发任务 -> 批量滚动导入 -> 别名切换。

## 安全与权限
- 公共接口，但需防刷：限流、验证码（连续 3 次失败时展示）。
- 埋点接口需要登录或匿名设备 ID，过滤恶意 payload。

## 前端接入要点
- 搜索框节流 300ms，输入为空不请求。
- 展示高亮字段 `<em>`，未知字段需兜底空字符串。
- 将 `traceId` 透传到前端日志，便于排查。
- 埋点失败时仅重试 1 次，避免阻塞 UI。
